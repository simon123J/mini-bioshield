{% extends "base.html" %}

{% block title %}bmi tracker{% endblock %}

{% block content %}
  <h1>bmi tracker</h1>
  <p class="subtitle">enter your weight and height.</p>

  {% if error %}
    <p class="error">{{ error }}</p>
  {% endif %}

  <form method="post">
    <div>
      <label>weight (pounds)</label><br />
      <input type="number" step="0.1" name="weight" />
    </div>

    <div>
      <label>height (inches)</label><br />
      <input type="number" step="0.1" name="height" />
    </div>

    <button type="submit">calculate</button>
  </form>

  {% if bmi %}
    <p class="result">
      <strong>bmi:</strong> {{ bmi }} – {{ category }}
    </p>
  {% endif %}

  {% if entries and entries|length > 0 %}
    <h2 class="subtitle" style="margin-top: 14px;">recent bmi history</h2>

    <div class="history-list">
      {% for row in entries %}
        <div class="history-item">
          <div><strong>{{ row["bmi"] }}</strong> ({{ row["category"] }})</div>
          <div style="font-size: 0.8rem;">
            weight: {{ row["weight"] }} lb • height: {{ row["height"] }} in
          </div>
          <div style="font-size: 0.75rem; opacity: 0.7;">
            {{ row["created_at"] }}
          </div>
        </div>
      {% endfor %}
    </div>

    <div class="chart-container">
      <canvas id="bmiChart"></canvas>
    </div>

    <!-- chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      const ctxBmi = document.getElementById("bmiChart").getContext("2d");

      const bmiLabels = [
        {% for row in entries|reverse %}
          "{{ row['created_at'] }}"{% if not loop.last %},{% endif %}
        {% endfor %}
      ];

      const bmiData = [
        {% for row in entries|reverse %}
          {{ row['bmi'] }}{% if not loop.last %},{% endif %}
        {% endfor %}
      ];

      const gradient = ctxBmi.createLinearGradient(0, 0, 0, 300);
      gradient.addColorStop(0, "rgba(51, 102, 255, 0.45)");
      gradient.addColorStop(1, "rgba(51, 102, 255, 0.05)");

      new Chart(ctxBmi, {
        type: "line",
        data: {
          labels: bmiLabels,
          datasets: [
            {
              label: "bmi over time",
              data: bmiData,
              fill: true,
              backgroundColor: gradient,
              borderColor: "#3366ff",
              borderWidth: 3,
              pointRadius: 5,
              pointBackgroundColor: "#3366ff",
              tension: 0.35
            }
          ]
        },
        options: {
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            x: {
              ticks: {
                autoSkip: true,
                maxRotation: 30,
                minRotation: 0,
                font: { size: 10 }
              },
              grid: {
                display: false
              }
            },
            y: {
              beginAtZero: false,
              grid: {
                color: "rgba(0,0,0,0.1)"
              }
            }
          }
        }
      });
    </script>
  {% endif %}
{% endblock %}
